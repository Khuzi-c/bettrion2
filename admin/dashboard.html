<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Bettrion Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/admin.css">
</head>

<body>

    <div class="main-content">
        <h1>Dashboard</h1>

        <div class="grid" id="stats-grid">
            <div class="stat-card">
                <h3 id="stat-platforms">-</h3>
                <p>Platforms</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-articles">-</h3>
                <p>Articles</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-views">-</h3>
                <p>Total Views</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-clicks">-</h3>
                <p>Total Clicks</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top:30px;">
            <div class="card">
                <h3>User Growth (Last 7 Days)</h3>
                <canvas id="growthChart"></canvas>
            </div>
            <div class="card">
                <h3>Browser Usage</h3>
                <canvas id="browserChart"></canvas>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Top Countries</h3>
            <canvas id="countryChart" style="max-height:300px;"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch stats from analytics endpoint
                const statsArray = await API.get('/analytics/stats');
                // Calculate checks
                const platforms = await API.get('/platforms');
                const articles = await API.get('/articles');
                const chartData = await API.get('/admin/charts');

                document.getElementById('stat-platforms').innerText = platforms ? platforms.length : 0;
                document.getElementById('stat-articles').innerText = articles ? articles.length : 0;
                // Views logic placeholder - assuming generic
                const views = statsArray && Array.isArray(statsArray) ? statsArray.length : 0;
                document.getElementById('stat-views').innerText = views;
                document.getElementById('stat-clicks').innerText = 0; // Placeholder

                if (chartData) {
                    initCharts(chartData);
                }

            } catch (err) {
                console.error(err);
            }
        });

        function initCharts(data) {
            // User Growth Line Chart
            new Chart(document.getElementById('growthChart'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'New Users',
                        data: data.userGrowth,
                        borderColor: '#e50914',
                        backgroundColor: 'rgba(229, 9, 20, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { grid: { color: '#333' } } }
                }
            });

            // Browser Doughnut Chart
            new Chart(document.getElementById('browserChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.browsers),
                    datasets: [{
                        data: Object.values(data.browsers),
                        backgroundColor: ['#36a2eb', '#ff6384', '#ffcd56', '#4bc0c0', '#9966ff'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } }
                }
            });

            // Country Bar Chart
            new Chart(document.getElementById('countryChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.countries),
                    datasets: [{
                        label: 'Visitors',
                        data: Object.values(data.countries),
                        backgroundColor: '#ffd700',
                        borderRadius: 4
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>

</html>