<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Payout - Bettrion Affiliate</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .payout-container {
            padding: 40px 0;
            max-width: 800px;
            margin: 0 auto;
        }

        .balance-card {
            background: linear-gradient(135deg, #1f1f1f, #000);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .balance-amount {
            font-size: 3rem;
            color: #46d369;
            font-weight: 800;
        }

        .form-card {
            background: #141414;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #222;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #888;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input,
        select {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .liability-shield {
            background: rgba(229, 9, 20, 0.1);
            border: 1px solid var(--primary);
            padding: 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #ffaeb2;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 40px;
        }

        .history-table th {
            text-align: left;
            color: #888;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .history-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #222;
            color: #ccc;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-paid {
            background: #46d369;
            color: black;
        }

        .status-processing {
            background: #ffd700;
            color: black;
        }

        .status-requested {
            background: #555;
            color: white;
        }

        .status-rejected {
            background: #e50914;
            color: white;
        }
    </style>
</head>

<body>

    <div id="sidebar-container"></div>

    <div class="main-content">
        <header>
            <div class="header-container">
                <div class="header-left">
                    <button class="menu-btn" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                    <a href="/" class="brand-link">
                        <img src="/assets/img/logo.webp" alt="Bettrion" class="brand-logo">
                        <span class="brand-text">Bettrion</span>
                    </a>
                </div>
            </div>
        </header>

        <div class="container payout-container">
            <a href="/affiliate/" class="btn-outline btn-sm">&larr; Back to Dashboard</a>
            <br><br>

            <div class="balance-card">
                <div style="color:#888; text-transform:uppercase;">Available Balance</div>
                <div class="balance-amount">$<span id="current-balance">0.00</span></div>
                <div style="font-size:0.9rem; margin-top:10px; color:#666;">Minimum Payout: $1.00</div>
            </div>

            <div class="form-card">
                <h3><i class="fas fa-coins" style="color:#ffd700"></i> Request Withdrawal</h3>
                <form id="payout-form">
                    <div class="form-group">
                        <label>Select Asset</label>
                        <select id="asset" name="asset" required>
                            <option value="USDT">USDT (Tether)</option>
                            <option value="USDC">USDC (USD Coin)</option>
                            <option value="LTC">Litecoin (LTC)</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Select Network</label>
                        <select id="network" name="network" required>
                            <option value="TRC20">TRC20 (Tron) - Recommended</option>
                            <option value="ERC20">ERC20 (Ethereum)</option>
                            <option value="BEP20">BEP20 (BSC)</option>
                            <option value="SOL">Solana</option>
                            <option value="BTC">Bitcoin</option>
                            <option value="LTC">Litecoin</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Wallet Address</label>
                        <input type="text" id="address" placeholder="e.g. T..." required>
                    </div>

                    <div class="form-group">
                        <label>Amount (USD)</label>
                        <input type="number" id="amount" step="0.01" min="1.00" placeholder="0.00" required>
                    </div>

                    <div class="liability-shield">
                        <input type="checkbox" id="confirm-legal" required style="width:20px; height:20px;">
                        <div>
                            <strong>Legal Liability Shield:</strong>
                            I confirm that the wallet address provided matches the selected network. I understand that
                            entering an incorrect address or network will result in the permanent loss of funds, and
                            Bettrion is NOT liable for such errors.
                        </div>
                    </div>

                    <button type="submit" class="btn-primary"
                        style="width:100%; padding: 20px; font-size: 1.5rem; font-weight: 800; text-transform: uppercase;">Submit
                        Payout Request</button>
                </form>
            </div>

            <h3>Withdrawal History</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Asset</th>
                        <th>Status</th>
                        <th>TXID</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr>
                        <td colspan="5" style="text-align:center">Loading history...</td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/api.js?v=4"></script>
    <script src="/assets/js/utils.js?v=4"></script>
    <script src="/assets/js/render.js?v=4"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Auth Check
            if (!localStorage.getItem('user_token')) {
                window.location.href = '/login.html?redirect=/affiliate/payout.html';
                return;
            }

            await loadData();

            // Form Submit
            document.getElementById('payout-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!confirm("Are you sure this address is correct? Cannot be undone.")) return;

                const payload = {
                    asset: document.getElementById('asset').value,
                    network: document.getElementById('network').value,
                    address: document.getElementById('address').value,
                    amount: document.getElementById('amount').value
                };

                try {
                    const res = await API.post('/affiliate/payout', payload);

                    if (res.success) {
                        alert('Payout Requested Successfully!');
                        loadData(); // Reload
                        document.getElementById('payout-form').reset();
                    } else {
                        alert('Error: ' + res.message);
                    }
                } catch (err) {
                    alert(err.message);
                }
            });
        });

        async function loadData() {
            try {
                // Get Stats
                const stats = await API.get('/affiliate/stats');
                document.getElementById('current-balance').innerText = stats.profile.balance.toFixed(2);
                document.getElementById('amount').max = stats.profile.balance;

                // Get History
                const hist = await API.get('/affiliate/payouts');
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = '';

                if (hist.payouts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No payouts yet.</td></tr>';
                    return;
                }

                hist.payouts.forEach(p => {
                    const tr = document.createElement('tr');
                    const date = new Date(p.created_at).toLocaleDateString();
                    const txLink = p.tx_id ? `<a href="#" onclick="alert('${p.tx_id}')">View</a>` : '-';

                    let statusClass = 'status-requested';
                    if (p.status === 'paid') statusClass = 'status-paid';
                    if (p.status === 'processing') statusClass = 'status-processing';
                    if (p.status === 'rejected') statusClass = 'status-rejected';

                    tr.innerHTML = `
                        <td>${date}</td>
                        <td>$${p.amount}</td>
                        <td>${p.asset} (${p.network})</td>
                        <td><span class="status-badge ${statusClass}">${p.status}</span></td>
                        <td>${txLink}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>

</html>