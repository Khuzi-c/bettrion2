<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Details - Bettrion Admin</title>
    <link rel="stylesheet" href="/assets/css/admin-v2.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <main class="admin-main">
        <a href="/admin/users.html" class="btn btn-outline" style="margin-bottom:20px;">⬅ Back to Users</a>

        <div class="card" id="user-profile">
            <h1 class="page-title" style="margin-top:0;">User Profile</h1>
            <div style="display:flex; gap:30px; align-items:flex-start;">
                <img id="u-avatar" src="/assets/img/default-avatar.png"
                    style="width:100px; height:100px; border-radius:50%; border:2px solid var(--accent);">

                <div style="flex:1;">
                    <h2 id="u-username" style="margin:0; font-size:2rem;">Loading...</h2>
                    <div id="u-email" style="color:#888;">...</div>
                    <div style="margin-top:10px;">
                        <span id="u-role" class="badge">Role</span>
                        <span id="u-status" class="badge">Status</span>
                    </div>
                </div>

                <div style="text-align:right;">
                    <div style="font-size:0.9rem; color:#aaa;">Wallet Balance</div>
                    <div class="stat-value" style="color:var(--primary);">$<span id="u-balance">0.00</span></div>
                    <button onclick="editBalance()" class="btn btn-sm btn-outline" style="margin-top:5px;">Edit
                        Balance</button>
                    <button onclick="editProfile()" class="btn btn-sm btn-primary" style="margin-top:5px;">✏️ Edit
                        Data</button>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px;">
            <!-- Actions -->
            <div class="card">
                <h3>⚡ "God Mode" Actions</h3>
                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                    <button onclick="changeRole()" class="btn btn-outline">Change Role</button>
                    <button onclick="toggleVerify()" class="btn btn-outline">Toggle Verified</button>
                    <button onclick="resetPass()" class="btn btn-outline">Reset Password</button>
                    <button onclick="banUser()" class="btn btn-delete">Ban/Unban</button>
                    <button onclick="nukeUser()" class="btn btn-delete">DELETE USER</button>
                </div>
            </div>

            <!-- Details -->
            <div class="card">
                <h3>ℹ️ Technical Details</h3>
                <table class="data-table" style="font-size:0.9rem;">
                    <tr>
                        <td>ID</td>
                        <td id="d-id">...</td>
                    </tr>
                    <tr>
                        <td>Created</td>
                        <td id="d-created">...</td>
                    </tr>
                    <tr>
                        <td>Last IP</td>
                        <td id="d-ip">...</td>
                    </tr>
                    <tr>
                        <td>Provider</td>
                        <td id="d-auth">...</td>
                    </tr>
                </table>
            </div>
        </div>
    </main>

    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/admin-v2.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');
        let userData = {};

        async function load() {
            if (!userId) { alert('No user ID'); return; }
            const res = await api.get('/admin/users/' + userId);
            if (res.success) {
                const u = res.data;
                userData = u;
                document.getElementById('u-username').innerText = u.username || 'No Name';
                document.getElementById('u-email').innerText = u.email;
                document.getElementById('u-role').innerText = u.role.toUpperCase();
                document.getElementById('u-status').innerText = u.banned ? 'BANNED' : 'ACTIVE';
                document.getElementById('u-status').className = 'badge ' + (u.banned ? 'badge-inactive' : 'badge-active');

                document.getElementById('u-balance').innerText = parseFloat(u.balance || 0).toFixed(2);

                // Avatar
                if (u.avatar_url) document.getElementById('u-avatar').src = u.avatar_url;

                // Details
                document.getElementById('d-id').innerText = u.id;
                document.getElementById('d-created').innerText = new Date(u.created_at).toLocaleString();
                document.getElementById('d-ip').innerText = u.ip_address || 'Unknown';
                document.getElementById('d-auth').innerText = u.auth_provider || 'email';
            }
        }

        async function editBalance() {
            const newBal = prompt('Enter new balance:', userData.balance);
            if (newBal === null) return;
            const res = await api.put(`/admin/users/${userId}/balance`, { balance: parseFloat(newBal) });
            if (res.success) load();
            else alert(res.error);
        }

        async function changeRole() {
            const role = prompt('Enter role (user, admin, owner, moderator, support):', userData.role);
            if (role === null) return;
            const res = await api.put(`/admin/users/${userId}/role`, { role: role.toLowerCase() });
            if (res.success) load();
            else alert(res.error);
        }

        async function toggleVerify() {
            const res = await api.post(`/admin/users/${userId}/verify`, { status: !userData.is_verified });
            if (res.success) { alert(res.message); load(); }
        }

        async function banUser() {
            const action = userData.banned ? 'unban' : 'ban';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;
            const res = await api.post(`/admin/users/${userId}/${action}`);
            if (res.success) load();
        }

        async function nukeUser() {
            if (!confirm('⚠️ DANGER: DELETE USER PERMANENTLY?')) return;
            const res = await api.delete(`/admin/users/${userId}`);
            if (res.success) { alert('User Deleted'); window.location.href = '/admin/users.html'; }
            else alert(res.error);
        }

        async function resetPass() {
            const p = prompt('Enter temporary password:');
            if (!p) return;
            const res = await api.post(`/admin/users/${userId}/password`, { newPassword: p });
            if (res.success) alert('Password updated');
        }

        async function editProfile() {
            // Populate Modal
            document.getElementById('edit-username').value = userData.username || '';
            document.getElementById('edit-email').value = userData.email || '';
            document.getElementById('edit-avatar').value = userData.avatar_url || '';
            document.getElementById('profile-modal').style.display = 'flex';
        }

        async function saveProfile(e) {
            e.preventDefault();
            const updates = {
                username: document.getElementById('edit-username').value,
                email: document.getElementById('edit-email').value,
                avatar_url: document.getElementById('edit-avatar').value
            };

            const p = document.getElementById('edit-password').value;
            if (p) updates.password = p;

            const res = await api.put(`/admin/users/${userId}/profile`, updates);
            if (res.success) {
                alert('Profile Updated');
                document.getElementById('profile-modal').style.display = 'none';
                load();
            } else {
                alert(res.error);
            }
        }

        window.addEventListener('load', load);
    </script>

    <!-- Profile Edit Modal -->
    <div id="profile-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="width:500px;">
            <h2>Edit User Profile</h2>
            <form onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" class="form-control">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-email" class="form-control">
                </div>
                <div class="form-group">
                    <label>Avatar URL</label>
                    <input type="text" id="edit-avatar" class="form-control">
                </div>
                <div class="form-group">
                    <label>Set New Password (Optional)</label>
                    <input type="text" id="edit-password" class="form-control"
                        placeholder="Leave empty to keep current">
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" onclick="document.getElementById('profile-modal').style.display='none'"
                        class="btn btn-outline">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>

</html>