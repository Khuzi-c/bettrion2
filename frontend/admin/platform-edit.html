<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Casino - Bettrion Admin</title>
    <link rel="stylesheet" href="/assets/css/admin.css"> <!-- Reverted to admin.css as base -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="/assets/js/admin-auth.js"></script>
    <style>
        .payments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            background: #0a0a0a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #222;
        }

        .payments-grid label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: normal;
        }
    </style>
</head>

<body>
    <!-- Sidebar Injection via JS or include -->
    <script src="/assets/js/admin-sidebar.js"></script>
    <script>
        document.body.insertAdjacentHTML('afterbegin', ADMIN_SIDEBAR_HTML);
    </script>

    <main class="main-content admin-main">
        <h1 id="page-title">Add New Casino</h1>
        <div class="card" style="max-width: 900px;">
            <form id="platform-form">
                <div class="form-group">
                    <label>Casino Name</label>
                    <input type="text" name="name" required>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Rating (0-5)</label>
                        <input type="number" step="0.1" name="rating" value="5.0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Category</label>
                        <input type="text" name="category" list="category-list" placeholder="Casino, Sports, Slots...">
                        <datalist id="category-list">
                            <option value="Casino">
                            <option value="Sports">
                            <option value="Slots">
                            <option value="Live Casino">
                        </datalist>
                    </div>
                </div>

                <div style="display: flex; gap: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Rank / Position (1=Top)</label>
                        <input type="number" name="ranking" value="999" placeholder="999">
                    </div>
                    <div class="form-group"
                        style="flex: 1; display:flex; align-items:center; gap:10px; margin-top:25px;">
                        <input type="checkbox" name="is_exclusive" id="excl_chk" style="width:20px; margin:0;">
                        <label for="excl_chk" style="margin:0; cursor:pointer;">Exclusive Casino?</label>
                    </div>
                </div>

                <div class="form-group"
                    style="background:#161616; padding:15px; border-radius:8px; border:1px solid #333; margin-top: 15px;">
                    <label style="color:#f39c12;">üåç Geo Visibility</label>
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                        <label
                            style="font-weight:normal; display:flex; align-items:center; gap:8px; cursor:pointer; font-size: 1rem;">
                            <input type="checkbox" id="global_chk" checked onchange="toggleCountries()"
                                style="width:18px; height:18px;">
                            <strong>Global (Available Everywhere)</strong>
                        </label>
                    </div>

                    <div id="countries_wrapper" style="display:none; margin-top:10px;">
                        <label style="font-size:0.9rem; color:#ccc; margin-bottom:5px; display:block;">Allowed Countries
                            Only:</label>
                        <!-- Container for Picker -->
                        <div id="country-picker-container"></div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Tags (comma separated)</label>
                    <input type="text" name="tags" placeholder="crypto, live-dealer, sports-betting">
                </div>

                <div class="form-group">
                    <label>Logo URL</label>
                    <input type="text" name="logo" required>
                </div>

                <div class="form-group">
                    <label>Banner URL (Hero Image)</label>
                    <input type="text" name="banner" placeholder="/assets/img/banners/example.jpg">
                </div>

                <div class="form-group">
                    <label>Linked Review Article</label>
                    <select name="review_article_id" id="article-select">
                        <option value="">-- Select Related Review --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Affiliate Link</label>
                    <input type="text" name="affiliate_link" required>
                </div>

                <div class="form-group">
                    <label>Short Description</label>
                    <textarea name="short_description" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Full Description (HTML Supported)</label>
                    <textarea name="description" rows="6"></textarea>
                </div>

                <!-- Payment Methods -->
                <div class="form-group">
                    <label>
                        Payment Methods
                        <span style="float:right;">
                            <button type="button" onclick="togglePaymentCheckboxes(true)"
                                style="background:#333; border:1px solid #555; color:#fff; cursor:pointer; padding:4px 10px; font-size:0.75rem; border-radius:4px; margin-right:5px;">Check
                                All</button>
                            <button type="button" onclick="togglePaymentCheckboxes(false)"
                                style="background:#333; border:1px solid #555; color:#fff; cursor:pointer; padding:4px 10px; font-size:0.75rem; border-radius:4px;">Clear</button>
                        </span>
                    </label>
                    <div class="payments-grid">
                        <label><input type="checkbox" name="payment_methods" value="Visa"> Visa</label>
                        <label><input type="checkbox" name="payment_methods" value="Mastercard"> Mastercard</label>
                        <label><input type="checkbox" name="payment_methods" value="PayPal"> PayPal</label>
                        <label><input type="checkbox" name="payment_methods" value="Bitcoin"> Bitcoin</label>
                        <label><input type="checkbox" name="payment_methods" value="Ethereum"> Ethereum</label>
                        <label><input type="checkbox" name="payment_methods" value="Tether"> USDT</label>
                        <label><input type="checkbox" name="payment_methods" value="Litecoin"> Litecoin</label>
                        <label><input type="checkbox" name="payment_methods" value="Solana"> Solana</label>
                        <label><input type="checkbox" name="payment_methods" value="Paysafe"> Paysafe</label>
                        <label><input type="checkbox" name="payment_methods" value="GooglePay"> Google Pay</label>
                        <label><input type="checkbox" name="payment_methods" value="ApplePay"> Apple Pay</label>
                        <label><input type="checkbox" name="payment_methods" value="CashApp"> CashApp</label>
                        <label><input type="checkbox" name="payment_methods" value="Venmo"> Venmo</label>
                        <label><input type="checkbox" name="payment_methods" value="Stripe"> Stripe</label>
                        <label><input type="checkbox" name="payment_methods" value="Binance"> Binance</label>
                    </div>
                </div>

                <!-- Features -->
                <div class="form-group">
                    <label>Key Features (Bulleted)</label>
                    <div id="features-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <input type="text" name="features[]" placeholder="Feature 1 (e.g. Instant Payouts)">
                        <input type="text" name="features[]" placeholder="Feature 2 (e.g. No KYC)">
                        <input type="text" name="features[]" placeholder="Feature 3 (e.g. 24/7 Support)">
                    </div>
                </div>

                <!-- Pros & Cons -->
                <div style="display:flex; gap:20px;">
                    <div class="form-group" style="flex:1;">
                        <label style="color:#2ecc71;">‚úÖ Pros</label>
                        <div id="pros-container" style="display: flex; flex-direction: column; gap: 8px;">
                            <input type="text" name="pros[]" placeholder="Pro 1">
                            <input type="text" name="pros[]" placeholder="Pro 2">
                        </div>
                        <button type="button" class="btn btn-sm" style="margin-top:5px;"
                            onclick="addInput('pros-container', 'pros[]', 'Pro')">+ Add Pro</button>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label style="color:#e74c3c;">‚ùå Cons</label>
                        <div id="cons-container" style="display: flex; flex-direction: column; gap: 8px;">
                            <input type="text" name="cons[]" placeholder="Con 1">
                            <input type="text" name="cons[]" placeholder="Con 2">
                        </div>
                        <button type="button" class="btn btn-sm" style="margin-top:5px;"
                            onclick="addInput('cons-container', 'cons[]', 'Con')">+ Add Con</button>
                    </div>
                </div>

                <div style="margin-top:20px; text-align:right;">
                    <button type="submit" class="btn btn-primary">Save Casino</button>
                </div>
                <div id="msg" style="margin-top: 10px;"></div>
            </form>
        </div>
    </main>

    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/admin-v2.js"></script>
    <script src="/admin/assets/js/country-picker.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        const isEditMode = !!editId;

        // Initialize Picker
        const picker = new CountryPicker('#country-picker-container');

        if (isEditMode) {
            document.getElementById('page-title').innerText = 'Edit Casino';
            loadExistingData();
        } else {
            loadArticles();
            toggleCountries(); // Init
        }

        // --- UI Helpers ---
        function toggleCountries() {
            const isGlobal = document.getElementById('global_chk').checked;
            document.getElementById('countries_wrapper').style.display = isGlobal ? 'none' : 'block';
        }

        function togglePaymentCheckboxes(state) {
            document.querySelectorAll('input[name="payment_methods"]').forEach(cb => cb.checked = state);
        }

        function addInput(containerId, name, placeholderPrefix) {
            const container = document.getElementById(containerId);
            const input = document.createElement('input');
            input.type = 'text';
            input.name = name;
            input.placeholder = `${placeholderPrefix} ${container.children.length + 1}`;
            container.appendChild(input);
        }

        async function loadArticles(selectedId = null) {
            try {
                const res = await api.get('/admin/articles');
                if (res.success || Array.isArray(res.data)) {
                    const articles = res.data || [];
                    const select = document.getElementById('article-select');
                    articles.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.id;
                        opt.innerText = a.title;
                        if (a.id === selectedId) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
            } catch (e) { console.error('Failed to load articles', e); }
        }

        async function loadExistingData() {
            try {
                const res = await api.get(`/platforms/${editId}`);
                if (!res.success && !res.id) return;

                const data = res.data || res;

                document.querySelector('[name="name"]').value = data.name || '';
                document.querySelector('[name="rating"]').value = data.rating || 5.0;
                document.querySelector('[name="category"]').value = data.category || '';
                document.querySelector('[name="tags"]').value = (Array.isArray(data.tags) ? data.tags.join(', ') : (data.tags || ''));

                let logoVal = data.logo;
                if (!logoVal && data.images && data.images.length > 0) logoVal = data.images[0];
                document.querySelector('[name="logo"]').value = logoVal || '';

                document.querySelector('[name="ranking"]').value = data.ranking || 999;
                if (data.is_exclusive) document.querySelector('[name="is_exclusive"]').checked = true;

                document.querySelector('[name="affiliate_link"]').value = data.affiliate_link || '';
                document.querySelector('[name="short_description"]').value = data.short_description || '';
                document.querySelector('[name="description"]').value = data.description || '';
                document.querySelector('[name="banner"]').value = data.banner || '';
                loadArticles(data.review_article_id);

                // Load Countries
                if (data.visibility_countries && Array.isArray(data.visibility_countries)) {
                    const isGlobal = data.visibility_countries.includes('global');
                    document.getElementById('global_chk').checked = isGlobal;
                    if (!isGlobal) {
                        picker.set(data.visibility_countries); // Use Set
                    }
                    toggleCountries();
                }

                // ... (Logic for Payments, Features, Pros, Cons)
                if (data.payment_methods) {
                    data.payment_methods.forEach(pm => {
                        const cb = document.querySelector(`input[name="payment_methods"][value="${pm}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                if (data.features && Array.isArray(data.features)) {
                    const inputs = document.querySelectorAll('input[name="features[]"]');
                    data.features.forEach((f, i) => {
                        if (inputs[i]) inputs[i].value = f;
                    });
                }

                if (data.pros && Array.isArray(data.pros)) {
                    const container = document.getElementById('pros-container');
                    container.innerHTML = '';
                    data.pros.forEach((p, i) => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = 'pros[]';
                        input.value = p;
                        container.appendChild(input);
                    });
                    if (data.pros.length === 0) addInput('pros-container', 'pros[]', 'Pro');
                }

                if (data.cons && Array.isArray(data.cons)) {
                    const container = document.getElementById('cons-container');
                    container.innerHTML = '';
                    data.cons.forEach((c, i) => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = 'cons[]';
                        input.value = c;
                        container.appendChild(input);
                    });
                    if (data.cons.length === 0) addInput('cons-container', 'cons[]', 'Con');
                }
            } catch (e) { console.error(e); }
        }

        document.getElementById('platform-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            if (data.tags) data.tags = data.tags.split(',').map(t => t.trim()).filter(t => t);
            if (data.logo) data.images = [data.logo];

            const payments = Array.from(document.querySelectorAll('input[name="payment_methods"]:checked')).map(cb => cb.value);
            data.payment_methods = payments;

            const features = Array.from(document.querySelectorAll('input[name="features[]"]')).map(i => i.value).filter(v => v);
            data.features = features;

            const pros = Array.from(document.querySelectorAll('input[name="pros[]"]')).map(i => i.value).filter(v => v);
            data.pros = pros;

            const cons = Array.from(document.querySelectorAll('input[name="cons[]"]')).map(i => i.value).filter(v => v);
            data.cons = cons;

            // Cleanups
            delete data['features[]'];
            delete data['pros[]'];
            delete data['cons[]'];

            data.rating = parseFloat(data.rating);
            data.ranking = parseInt(data.ranking) || 999;
            data.is_exclusive = document.querySelector('[name="is_exclusive"]').checked;

            // Handle Countries
            const isGlobal = document.getElementById('global_chk').checked;
            if (isGlobal) {
                data.visibility_countries = ['global']; // Correct Field Name!
            } else {
                // Get from picker input (name="countries_visible")
                // And map to backend field 'visibility_countries'
                const raw = document.getElementById('countries-hidden-input').value; // from Picker JS (check country-picker.js)
                // Actually CountryPicker.js updates #countries-hidden-input
                // But let's check input name there.
                // In CountryPicker.js: <input type="hidden" name="countries_visible" id="countries-hidden-input">

                // So data.countries_visible should hold the value 'US, GB...'
                data.visibility_countries = data.countries_visible ? data.countries_visible.split(',').map(s => s.trim()) : [];
            }
            delete data.countries_visible; // Cleanup aux field

            const msg = document.getElementById('msg');
            let res;

            try {
                if (isEditMode) {
                    res = await api.put(`/platforms/${editId}`, data);
                } else {
                    res = await api.post('/platforms', data);
                }

                if (res.success || res.id) {
                    msg.innerHTML = '<span style="color: green;">‚úÖ Casino saved successfully!</span>';
                    if (!isEditMode) setTimeout(() => window.location.reload(), 1500);
                } else {
                    msg.innerHTML = `<span style="color: red;">‚ùå Error: ${res.error || res.message || 'Unknown error'}</span>`;
                }
            } catch (e) {
                msg.innerHTML = `<span style="color: red;">‚ùå Exception: ${e.message}</span>`;
            }
        });
    </script>
</body>

</html>